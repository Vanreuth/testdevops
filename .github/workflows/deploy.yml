name: Deploy to Contabo VPS

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Install Ansible & MongoDB modules
      run: |
        sudo apt-get update
        sudo apt-get install -y ansible python3-pip
        pip3 install pymongo ansible[community]

    - name: Setup SSH key with passphrase
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.CONTABO_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        eval "$(ssh-agent -s)"
        ssh-add - <<< "${{ secrets.CONTABO_SSH_KEY_PASSPHRASE }}"
      shell: bash

    - name: Run Ansible Playbook
      run: ansible-playbook -i inventory.ini deploy.yml
      env:
        ANSIBLE_HOST_KEY_CHECKING: False
        APP_PORT: ${{ secrets.APP_PORT }}
        MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
